!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.WebGLCanvas=e()}(this,function(){function t(t,e,r){this.canvasElement=t,this.contextOptions=r,e||this.initContextGL(),this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures())}return t.prototype.isWebGL=function(){return this.contextGL},t.prototype.initContextGL=function(){for(var t=this.canvasElement,e=null,r=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=0;!e&&i<r.length;){var a=r[i];try{e=this.contextOptions?t.getContext(a,this.contextOptions):t.getContext(a)}catch(o){e=null}e&&"function"==typeof e.getParameter||(e=null),++i}this.contextGL=e},t.prototype.initProgram=function(){var t=this.contextGL,e=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","}"].join("\n"),r=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","const mat4 YUV2RGB = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","void main(void) {","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u = texture2D(uSampler,  textureCoord).r;","highp float v = texture2D(vSampler,  textureCoord).r;","gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n"),i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)||console.log("Vertex shader failed to compile: "+t.getShaderInfoLog(i));var a=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(a,r),t.compileShader(a),t.getShaderParameter(a,t.COMPILE_STATUS)||console.log("Fragment shader failed to compile: "+t.getShaderInfoLog(a));var o=t.createProgram();t.attachShader(o,i),t.attachShader(o,a),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||console.log("Program failed to compile: "+t.getProgramInfoLog(o)),t.useProgram(o),this.shaderProgram=o},t.prototype.initBuffers=function(){var t=this.contextGL,e=this.shaderProgram,r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW);var i=t.getAttribLocation(e,"vertexPos");t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0);var a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var o=t.getAttribLocation(e,"texturePos");t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0),this.texturePosBuffer=a},t.prototype.initTextures=function(){var t=this.contextGL,e=this.shaderProgram,r=this.initTexture(),i=t.getUniformLocation(e,"ySampler");t.uniform1i(i,0),this.yTextureRef=r;var a=this.initTexture(),o=t.getUniformLocation(e,"uSampler");t.uniform1i(o,1),this.uTextureRef=a;var n=this.initTexture(),u=t.getUniformLocation(e,"vSampler");t.uniform1i(u,2),this.vTextureRef=n},t.prototype.initTexture=function(){var t=this.contextGL,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),e},t.prototype.drawNextOutputPicture=function(t,e,r,i){var a=this.contextGL;a?this.drawNextOuptutPictureGL(t,e,r,i):this.drawNextOuptutPictureRGBA(t,e,r,i)},t.prototype.drawNextOuptutPictureGL=function(t,e,r,i){var a=this.contextGL,o=this.texturePosBuffer,n=this.yTextureRef,u=this.uTextureRef,T=this.vTextureRef;if(null===r)a.viewport(0,0,t,e);else{a.viewport(0,0,r.width,r.height);var s=r.top/e,h=r.left/t,x=r.height/e,E=r.width/t,f=new Float32Array([E,s,h,s,E,x,h,x]);a.bindBuffer(a.ARRAY_BUFFER,o),a.bufferData(a.ARRAY_BUFFER,f,a.DYNAMIC_DRAW)}var c=i,l=t*e,m=c.subarray(0,l);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,n),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,t,e,0,a.LUMINANCE,a.UNSIGNED_BYTE,m);var R=t/2*e/2,p=c.subarray(l,l+R);a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,u),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,t/2,e/2,0,a.LUMINANCE,a.UNSIGNED_BYTE,p);var g=R,d=c.subarray(l+R,l+R+g);a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,T),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,t/2,e/2,0,a.LUMINANCE,a.UNSIGNED_BYTE,d),a.drawArrays(a.TRIANGLE_STRIP,0,4)},t.prototype.drawNextOuptutPictureRGBA=function(t,e,r,i){var a=this.canvasElement,r=null,o=i,n=a.getContext("2d"),u=n.getImageData(0,0,t,e);u.data.set(o),null===r?n.putImageData(u,0,0):n.putImageData(u,-r.left,-r.top,0,0,r.width,r.height)},t});